(function($){let ajax=null;let form=null;const bp=$(".batchpress");const upload=$(".batchpress-upload");const message=$(".batchpress-message");const log=$(".batchpress-log");const nonce=bp.data("nonce");bp.on("click",".batchpress-option",option);bp.on("submit",".batchpress-form",submit);bp.on("click",".batchpress-stop",stop);bp.on("click",".batchpress-back",back);function option(){upload.toggleClass("batchpress-show",$(this).data("upload")===1);bp.find(".batchpress-button").attr("disabled",false)}function process(process){form.append("process",process);ajax=$.ajax({method:"POST",url:ajaxurl,processData:false,contentType:false,data:form}).done(done).fail(failed)}function submit(e){e.preventDefault();const option=bp.find("input[name=job]:checked");form=new FormData;form.append("job",option.val());form.append("nonce",nonce);form.append("action","batchpress");form.append("file",null);if(option.data("upload")===1){const files=upload.find("input")[0].files;form.append("file",files.length?files[0]:null);process("upload")}else{process("start")}bp.addClass("batchpress-processing");message.find(".batchpress-message-job").html(option.data("label")||form.get("job").replaceAll("-"," "));message.find(".batchpress-message-status").html(message.data("message"))}function stop(){try{ajax.abort()}catch(error){console.error(`Abort: ${error}`)}finally{clear();process("stop");bp.removeClass("batchpress-processing batchpress-error")}}function done(data){data=parse(data);status(data);if(data.status==="processing"){return process("run")}}function failed(data){status(parse(data));bp.addClass("batchpress-error")}function status(data){message.find(".batchpress-message-status").html(data.message);bp.addClass("batchpress-"+data.status);if(data.log){const count=Number(log.find(".batchpress-log-count").html());log.find("ul").append(data.log.map(entry=>`<li>${entry}</li>`));log.find(".batchpress-log-count").html(count+data.log.length)}}function clear(){log.find("ul").empty();log.find(".batchpress-log-count").html(0)}function back(){clear();bp.removeClass("batchpress-done batchpress-error batchpress-processing")}function parse(data){try{return $.parseJSON(data)}catch(error){return{status:"error",message:error}}}})(jQuery);